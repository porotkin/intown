(this.webpackJsonpintown=this.webpackJsonpintown||[]).push([[0],{173:function(e,t,n){e.exports=n(270)},270:function(e,t,n){"use strict";n.r(t);n(174),n(200),n(202),n(203),n(205),n(206),n(207),n(208),n(209),n(210),n(211),n(212),n(214),n(215),n(216),n(217),n(218),n(219),n(220),n(221),n(222),n(223),n(225),n(226),n(227),n(228),n(229),n(230),n(231),n(232),n(233),n(234),n(235),n(236),n(237),n(238),n(239),n(240),n(241),n(242);var r=n(0),a=n.n(r),s=n(28),o=n.n(s),c=n(20),i=n.n(c),u=n(18),l=n(22),d=n(53),p=n(26),h=n(25),f=n(10),b=(n(47),n(104)),m=n.n(b),S=n(105),g=n.n(S),E=n(13),v=n.n(E),y=n(27),_=function e(){Object(u.a)(this,e)};_.SERVER_API_ADDRESS="https://intown-backend.herokuapp.com/",_.VK_APP_ID=7550756,_.VK_API_VERSION="5.122";var O=function e(){Object(u.a)(this,e)};O.getSubscribers=function(){var e=Object(y.a)(v.a.mark((function e(t){return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,fetch(_.SERVER_API_ADDRESS+"user/"+t,{mode:"cors",method:"GET",headers:{"Content-Type":"application/json"}});case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),O.addSubscriber=function(){var e=Object(y.a)(v.a.mark((function e(t,n){return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,fetch(_.SERVER_API_ADDRESS+"user/add",{mode:"cors",method:"POST",headers:{"Content-type":"application/json"},body:JSON.stringify({id:t,subscriber:n})});case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),O.removeSubscriber=function(){var e=Object(y.a)(v.a.mark((function e(t,n){return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,fetch(_.SERVER_API_ADDRESS+"user/remove",{mode:"cors",method:"DELETE",headers:{"Content-type":"application/json"},body:JSON.stringify({id:t,subscriber:n})});case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),O.getUserLocation=function(){var e=Object(y.a)(v.a.mark((function e(t){return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,fetch(_.SERVER_API_ADDRESS+"location/"+t,{mode:"cors",method:"GET",headers:{"Content-Type":"application/json"}});case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),O.addUserLocation=function(){var e=Object(y.a)(v.a.mark((function e(t,n,r){return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,fetch(_.SERVER_API_ADDRESS+"location/add",{mode:"cors",method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:t,date:(new Date).toLocaleDateString("en-US"),lat:n,long:r})});case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}();var j=function(e){Object(p.a)(n,e);var t=Object(h.a)(n);function n(e){var r;return Object(u.a)(this,n),(r=t.call(this,e)).subscribeToggle=function(){r.state.subscribed?(r.setState({on:"primary",text:"\u041f\u043e\u0434\u043f\u0438\u0441\u0430\u0442\u044c\u0441\u044f",subscribed:!1}),O.removeSubscriber(r.props.user_id,r.props.friend_id).then()):(r.setState({on:"secondary",text:"\u041e\u0442\u043f\u0438\u0441\u0430\u0442\u044c\u0441\u044f",subscribed:!0}),O.addSubscriber(r.props.user_id,r.props.friend_id).then())},r.state=r.props.subscribed?{on:"secondary",text:"\u041e\u0442\u043f\u0438\u0441\u0430\u0442\u044c\u0441\u044f",subscribed:!0}:{on:"primary",text:"\u041f\u043e\u0434\u043f\u0438\u0441\u0430\u0442\u044c\u0441\u044f",subscribed:!1},r}return Object(l.a)(n,[{key:"render",value:function(){return a.a.createElement(f.c,null,a.a.createElement(f.b,{mode:this.state.on,onClick:this.subscribeToggle},this.state.text))}}]),n}(a.a.Component),k=n(107),x=n.n(k),A=n(106),C=n.n(A),w=function(e){Object(p.a)(n,e);var t=Object(h.a)(n);function n(e){var r;return Object(u.a)(this,n),(r=t.call(this,e)).searchChange=function(e){r.setState({search:e.target.value})},r.getFriends=function(){var e=Object(y.a)(v.a.mark((function e(t){return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,i.a.send("VKWebAppCallAPIMethod",{method:"friends.get",request_id:"32test",params:{fields:"id, photo_50",order:"name",access_token:t,v:_.VK_API_VERSION}});case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),r.state={friends:null,user_id:null,subscribers:null,search:""},i.a.send("VKWebAppGetUserInfo",{}).then((function(e){O.getSubscribers(e.id).then((function(t){t.json().then((function(t){i.a.send("VKWebAppGetAuthToken",{app_id:_.VK_APP_ID,scope:"friends"}).then((function(n){r.getFriends(n.access_token).then((function(n){r.setState({user_id:e.id,subscribers:t.subs,friends:n.response.items})}))}))}))}),(function(e){console.log(e)}))})),r}return Object(l.a)(n,[{key:"friends",get:function(){var e=this.state.search.toUpperCase();return""!==this.state.search?this.state.friends.filter((function(t){return t.first_name.toUpperCase().indexOf(e)>-1||t.last_name.toUpperCase().indexOf(e)>-1})):this.state.friends}}]),Object(l.a)(n,[{key:"render",value:function(){var e=this;return a.a.createElement(f.e,null,a.a.createElement(f.f,{mode:"secondary",popout:this.state.popout},"\u0421\u043f\u0438\u0441\u043e\u043a \u0434\u0440\u0443\u0437\u0435\u0439"),a.a.createElement(C.a,{value:this.state.search,onChange:this.searchChange,after:null}),this.state.friends?this.friends.map((function(t){return a.a.createElement(x.a,{key:t.id,before:a.a.createElement(f.a,{size:48,src:t.photo_50}),after:a.a.createElement(j,{user_id:e.state.user_id,friend_id:t.id,subscribed:!!e.state.subscribers&&e.state.subscribers.includes(t.id)})},t.first_name+" "+t.last_name)})):a.a.createElement(f.j,{size:"regular",style:{marginTop:20}}))}}]),n}(a.a.Component),I=function(e){Object(p.a)(n,e);var t=Object(h.a)(n);function n(e){return Object(u.a)(this,n),t.call(this,e)}return Object(l.a)(n,[{key:"render",value:function(){return a.a.createElement(f.c,{style:{textAlign:"center",marginTop:"3%"}},a.a.createElement(f.b,{mode:"commerce",size:"xl",onClick:this.props.onClick},"\u041f\u043e\u0434\u0435\u043b\u0438\u0442\u044c\u0441\u044f \u0433\u0435\u043e\u043f\u043e\u0437\u0438\u0446\u0438\u0435\u0439"))}}]),n}(a.a.Component),R=n(108),V={position:"absolute",top:"50%",left:"50%",width:"15px",height:"15px",backgroundColor:"#0cb",border:"2px solid #fff",borderRadius:"40%",userSelect:"none",transform:"translate(-50%, -50%)"},P={width:"500px",transform:"translate(-7%, 0)",fontSize:"12pt"},D={width:"500px",transform:"translate(-7%, -15px)",fontSize:"9pt"},G=function(e){Object(p.a)(n,e);var t=Object(h.a)(n);function n(){return Object(u.a)(this,n),t.apply(this,arguments)}return Object(l.a)(n,[{key:"render",value:function(){return a.a.createElement("div",{style:V},a.a.createElement("p",{style:P},this.props.name),a.a.createElement("p",{style:D},this.props.date))}}]),n}(a.a.Component),T=function(e){Object(p.a)(n,e);var t=Object(h.a)(n);function n(e){var r;return Object(u.a)(this,n),(r=t.call(this,e)).getGeo=Object(y.a)(v.a.mark((function e(){return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,i.a.send("VKWebAppGetGeodata");case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)}))),r.sendGeoToServer=Object(y.a)(v.a.mark((function e(){return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.getGeo().then((function(e){0!==e.lat&&0!==e.long&&(O.addUserLocation(r.state.user_id,e.lat,e.long),r.setState({geoLocation:{lat:e.lat,lng:e.long}}))}));case 2:case"end":return e.stop()}}),e)}))),r.getGeoDataFromServer=Object(y.a)(v.a.mark((function e(){var t;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=[],e.next=3,i.a.send("VKWebAppGetUserInfo").then((function(e){r.setState({user_id:e.id}),O.getSubscribers(e.id).then((function(e){e.json().then((function(e){i.a.send("VKWebAppGetAuthToken",{app_id:_.VK_APP_ID,scope:"users"}).then((function(n){i.a.send("VKWebAppCallAPIMethod",{method:"users.get",request_id:"64test",params:{user_ids:e.subs.toString(),fields:"first_name, last_name",v:_.VK_API_VERSION,access_token:n.access_token}}).then((function(e){e.response.forEach((function(e){O.getUserLocation(e.id).then((function(n){n.json().then((function(n){if(""!==n.date){var r={id:n.id,name:e.first_name+" "+e.last_name,date:n.date,lat:n.lat,lng:n.lng};t.push(r)}}))}))})),r.setState({subscribers:t})}))}))}))}))}));case 3:case"end":return e.stop()}}),e)}))),r.state={geoLocation:null,subscribers:null,user_id:null},r.getGeoDataFromServer(),r}return Object(l.a)(n,[{key:"render",value:function(){return this.state.subscribers?a.a.createElement(f.e,{style:{height:"65vh",width:"95%",marginLeft:"auto",marginRight:"auto"}},a.a.createElement(R.a,{bootstrapURLKeys:{key:"AIzaSyCA-CWX9xnTnxGmzIxkH_WIsGUrdeRI444"},center:this.state.geoLocation?this.state.geoLocation:this.props.center,zoom:this.props.zoom},this.state.geoLocation?a.a.createElement(G,{lat:this.state.geoLocation.lat,lng:this.state.geoLocation.lng,name:"\u0412\u044b",date:(new Date).toISOString().split("T")[0]}):"",this.state.subscribers.map((function(e){return a.a.createElement(G,{key:e.id,lat:e.lat,lng:e.lng,name:e.name,date:e.date})}))),a.a.createElement(I,{onClick:this.sendGeoToServer})):a.a.createElement(f.i,{size:"large"})}}]),n}(a.a.Component);T.defaultProps={center:{lat:30,lng:30},zoom:7};var K=T,L=function(e){Object(p.a)(n,e);var t=Object(h.a)(n);function n(e){var r;return Object(u.a)(this,n),(r=t.call(this,e)).state={activeStory:"Subs"},r.onStoryChange=r.onStoryChange.bind(Object(d.a)(r)),r}return Object(l.a)(n,[{key:"onStoryChange",value:function(e){this.setState({activeStory:e.currentTarget.dataset.story})}},{key:"render",value:function(){return a.a.createElement(f.d,{activeStory:this.state.activeStory,tabbar:a.a.createElement(f.k,null,a.a.createElement(f.l,{onClick:this.onStoryChange,selected:"Subs"===this.state.activeStory,"data-story":"Subs",text:"\u041f\u043e\u0434\u043f\u0438\u0441\u043a\u0438"},a.a.createElement(m.a,{fill:"#FF7F50"})),a.a.createElement(f.l,{onClick:this.onStoryChange,selected:"Geo"===this.state.activeStory,"data-story":"Geo",text:"\u0413\u0435\u043e\u043b\u043e\u043a\u0430\u0446\u0438\u044f"},a.a.createElement(g.a,{fill:"#228B22"})))},a.a.createElement(f.m,{id:"Subs",activePanel:"Subs"},a.a.createElement(f.g,{id:"Subs"},a.a.createElement(f.h,{separator:!1},"\u041f\u043e\u0434\u043f\u0438\u0441\u043a\u0438"),a.a.createElement(w,null))),a.a.createElement(f.m,{id:"Geo",activePanel:"Geo"},a.a.createElement(f.g,{id:"Geo"},a.a.createElement(f.h,{separator:!1},"\u0413\u0435\u043e\u043b\u043e\u043a\u0430\u0446\u0438\u044f"),a.a.createElement(K,null))))}}]),n}(a.a.Component);i.a.send("VKWebAppInit").then(),o.a.render(a.a.createElement(L,null),document.getElementById("root"))}},[[173,1,2]]]);
//# sourceMappingURL=main.f85ef41b.chunk.js.map